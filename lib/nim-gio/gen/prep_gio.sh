#!/bin/bash
# S. Salewski, 07-MAR-2015
# Generate gio bindings for Nim -- this is for latest glib 2.43.90
#
glib_dir="/home/stefan/Downloads/glib-2.43.90"
final="final.h" # the input file for c2nim
list="list.txt"
wdir="tmp"

targets=''
all_t=". ${targets}"

rm -rf $wdir # start from scratch
mkdir $wdir
cd $wdir
cp -r $glib_dir/gio .
cd gio

# check already done for 2,43.90...
#echo 'we may miss these headers -- please check:'
#for i in $all_t ; do
#  grep -c DECL ${i}/*.h | grep h:0
#done

# we insert in each header a marker with the filename
# may fail if G_BEGIN_DECLS macro is missing in a header
for j in $all_t ; do
  for i in ${j}/*.h; do
    sed -i "/^G_BEGIN_DECLS/a${i}_ssalewski;" $i
  done
done

cat gio.h > all.h

cd ..

# cpp run with all headers to determine order
echo "cat \\" > $list

cpp -I. `pkg-config --cflags gtk+-3.0` gio/all.h $final

# extract file names and push names to list
grep ssalewski $final | sed 's/_ssalewski;/ \\/' >> $list

# maybe add remaining missing headers

i=`uniq -d $list | wc -l`
if [ $i != 0 ]; then echo 'list contains duplicates!'; exit; fi;

# now we work again with original headers
rm -rf gio
cp -r $glib_dir/gio . 

# insert for each header file its name as first line
for j in $all_t ; do
  for i in gio/${j}/*.h; do
    sed -i "1i/* file: $i */" $i
    sed -i "1i#define headerfilename \"$i\"" $i # marker for splitting
  done
done
cd gio
  bash ../$list > ../$final
cd ..

# delete strange macros (define these as empty ones for c2nim)
sed -i "1i#def G_BEGIN_DECLS" $final
sed -i "1i#def G_END_DECLS" $final
sed -i "1i#def G_GNUC_CONST" $final
sed -i "1i#def GLIB_AVAILABLE_IN_ALL" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_26" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_28" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_30" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_32" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_34" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_36" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_38" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_40" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_42" $final
sed -i "1i#def GLIB_AVAILABLE_IN_2_44" $final
sed -i "1i#def GLIB_DEPRECATED" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_36" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_40" $final
sed -i "1i#def GLIB_DEPRECATED_FOR(x)" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_36_FOR(x)" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_38_FOR(x)" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_40_FOR(x)" $final
sed -i "1i#def GLIB_DEPRECATED_IN_2_42_FOR(x)" $final
sed -i "1i#def G_GNUC_PRINTF(i, j)" $final
sed -i "1i#def G_GNUC_NULL_TERMINATED" $final
sed -i "1i#def G_DECLARE_FINAL_TYPE(a, b, c, d, e)" $final

i='GLIB_AVAILABLE_IN_2_44
G_DECLARE_INTERFACE(GListModel, g_list_model, G, LIST_MODEL, GObject)

struct _GListModelInterface
{
  GTypeInterface g_iface;

  GType     (* get_item_type)   (GListModel *list);

  guint     (* get_n_items)     (GListModel *list);

  gpointer  (* get_item)        (GListModel *list,
                                 guint       position);
};
'
perl -0777 -p -i -e "s%\Q$i\E%%s" $final

i='#if 0
/**
 * GFile:
 *
 * A handle to an object implementing the #GFileIface interface.
 * Generally stores a location within the file system. Handles do not
 * necessarily represent files or directories that currently exist.
 **/
typedef struct _GFile         		GFile; /* Dummy typedef */
#endif
'
perl -0777 -p -i -e "s%\Q$i\E%%s" $final

i='#ifdef G_OS_UNIX
/* To get the uid_t type */
#include <unistd.h>
#include <sys/types.h>
#endif
'
perl -0777 -p -i -e "s%\Q$i\E%%s" $final

# this is generated by find_opaque_structs.rb
sed -i 's/typedef struct _GAppInfo                      GAppInfo;/typedef struct _GAppInfo{} GAppInfo;/' final.h
sed -i 's/typedef struct _GAsyncResult                  GAsyncResult;/typedef struct _GAsyncResult{} GAsyncResult;/' final.h
sed -i 's/typedef struct _GAsyncInitable                GAsyncInitable;/typedef struct _GAsyncInitable{} GAsyncInitable;/' final.h
sed -i 's/typedef struct _GCharsetConverter             GCharsetConverter;/typedef struct _GCharsetConverter{} GCharsetConverter;/' final.h
sed -i 's/typedef struct _GConverter                    GConverter;/typedef struct _GConverter{} GConverter;/' final.h
sed -i 's/typedef struct _GSimplePermission             GSimplePermission;/typedef struct _GSimplePermission{} GSimplePermission;/' final.h
sed -i 's/typedef struct _GZlibCompressor               GZlibCompressor;/typedef struct _GZlibCompressor{} GZlibCompressor;/' final.h
sed -i 's/typedef struct _GZlibDecompressor             GZlibDecompressor;/typedef struct _GZlibDecompressor{} GZlibDecompressor;/' final.h
sed -i 's/typedef struct _GRemoteActionGroup            GRemoteActionGroup;/typedef struct _GRemoteActionGroup{} GRemoteActionGroup;/' final.h
sed -i 's/typedef struct _GDBusActionGroup              GDBusActionGroup;/typedef struct _GDBusActionGroup{} GDBusActionGroup;/' final.h
sed -i 's/typedef struct _GActionMap                    GActionMap;/typedef struct _GActionMap{} GActionMap;/' final.h
sed -i 's/typedef struct _GActionGroup                  GActionGroup;/typedef struct _GActionGroup{} GActionGroup;/' final.h
sed -i 's/typedef struct _GPropertyAction               GPropertyAction;/typedef struct _GPropertyAction{} GPropertyAction;/' final.h
sed -i 's/typedef struct _GSimpleAction                 GSimpleAction;/typedef struct _GSimpleAction{} GSimpleAction;/' final.h
sed -i 's/typedef struct _GAction                       GAction;/typedef struct _GAction{} GAction;/' final.h
sed -i 's/typedef struct _GSettingsBackend              GSettingsBackend;/typedef struct _GSettingsBackend{} GSettingsBackend;/' final.h
sed -i 's/typedef struct _GNotification                 GNotification;/typedef struct _GNotification{} GNotification;/' final.h
sed -i 's/typedef struct _GListModel                    GListModel;/typedef struct _GListModel{} GListModel;/' final.h
sed -i 's/typedef struct _GListStore                    GListStore;/typedef struct _GListStore{} GListStore;/' final.h
sed -i 's/typedef struct _GDrive                        GDrive;/typedef struct _GDrive{} GDrive;/' final.h
sed -i 's/typedef struct _GFile                         GFile;/typedef struct _GFile{} GFile;/' final.h
sed -i 's/typedef struct _GFileInfo                     GFileInfo;/typedef struct _GFileInfo{} GFileInfo;/' final.h
sed -i 's/typedef struct _GFileAttributeMatcher         GFileAttributeMatcher;/typedef struct _GFileAttributeMatcher{} GFileAttributeMatcher;/' final.h
sed -i 's/typedef struct _GFileDescriptorBased          GFileDescriptorBased;/typedef struct _GFileDescriptorBased{} GFileDescriptorBased;/' final.h
sed -i 's/typedef struct _GFileIcon                     GFileIcon;/typedef struct _GFileIcon{} GFileIcon;/' final.h
sed -i 's/typedef struct _GFilenameCompleter            GFilenameCompleter;/typedef struct _GFilenameCompleter{} GFilenameCompleter;/' final.h
sed -i 's/typedef struct _GIcon                         GIcon;/typedef struct _GIcon{} GIcon;/' final.h
sed -i 's/typedef struct _GInitable                     GInitable;/typedef struct _GInitable{} GInitable;/' final.h
sed -i 's/typedef struct _GIOModule                     GIOModule;/typedef struct _GIOModule{} GIOModule;/' final.h
sed -i 's/typedef struct _GIOExtensionPoint             GIOExtensionPoint;/typedef struct _GIOExtensionPoint{} GIOExtensionPoint;/' final.h
sed -i 's/typedef struct _GIOExtension                  GIOExtension;/typedef struct _GIOExtension{} GIOExtension;/' final.h
sed -i 's/typedef struct _GIOSchedulerJob               GIOSchedulerJob;/typedef struct _GIOSchedulerJob{} GIOSchedulerJob;/' final.h
sed -i 's/typedef struct _GIOStreamAdapter              GIOStreamAdapter;/typedef struct _GIOStreamAdapter{} GIOStreamAdapter;/' final.h
sed -i 's/typedef struct _GLoadableIcon                 GLoadableIcon;/typedef struct _GLoadableIcon{} GLoadableIcon;/' final.h
sed -i 's/typedef struct _GBytesIcon                    GBytesIcon;/typedef struct _GBytesIcon{} GBytesIcon;/' final.h
sed -i 's/typedef struct _GMount                        GMount;/typedef struct _GMount{} GMount;/' final.h
sed -i 's/typedef struct _GNetworkMonitor               GNetworkMonitor;/typedef struct _GNetworkMonitor{} GNetworkMonitor;/' final.h
sed -i 's/typedef struct _GSimpleIOStream               GSimpleIOStream;/typedef struct _GSimpleIOStream{} GSimpleIOStream;/' final.h
sed -i 's/typedef struct _GPollableInputStream          GPollableInputStream;/typedef struct _GPollableInputStream{} GPollableInputStream;/' final.h
sed -i 's/typedef struct _GPollableOutputStream         GPollableOutputStream;/typedef struct _GPollableOutputStream{} GPollableOutputStream;/' final.h
sed -i 's/typedef struct _GResource                     GResource;/typedef struct _GResource{} GResource;/' final.h
sed -i 's/typedef struct _GSeekable                     GSeekable;/typedef struct _GSeekable{} GSeekable;/' final.h
sed -i 's/typedef struct _GSimpleAsyncResult            GSimpleAsyncResult;/typedef struct _GSimpleAsyncResult{} GSimpleAsyncResult;/' final.h
sed -i 's/typedef struct _GSocketConnectable            GSocketConnectable;/typedef struct _GSocketConnectable{} GSocketConnectable;/' final.h
sed -i 's/typedef struct _GSrvTarget                    GSrvTarget;/typedef struct _GSrvTarget{} GSrvTarget;/' final.h
sed -i 's/typedef struct _GTask                         GTask;/typedef struct _GTask{} GTask;/' final.h
sed -i 's/typedef struct _GThemedIcon                   GThemedIcon;/typedef struct _GThemedIcon{} GThemedIcon;/' final.h
sed -i 's/typedef struct _GTlsClientConnection          GTlsClientConnection;/typedef struct _GTlsClientConnection{} GTlsClientConnection;/' final.h
sed -i 's/typedef struct _GTlsFileDatabase              GTlsFileDatabase;/typedef struct _GTlsFileDatabase{} GTlsFileDatabase;/' final.h
sed -i 's/typedef struct _GTlsServerConnection          GTlsServerConnection;/typedef struct _GTlsServerConnection{} GTlsServerConnection;/' final.h
sed -i 's/typedef struct _GProxyResolver                GProxyResolver;/typedef struct _GProxyResolver{} GProxyResolver;/' final.h
sed -i 's/typedef struct _GProxy			      GProxy;/typedef struct _GProxy{} GProxy;/' final.h
sed -i 's/typedef struct _GVolume                       GVolume;/typedef struct _GVolume{} GVolume;/' final.h
sed -i 's/typedef struct _GCredentials                  GCredentials;/typedef struct _GCredentials{} GCredentials;/' final.h
sed -i 's/typedef struct _GUnixCredentialsMessage       GUnixCredentialsMessage;/typedef struct _GUnixCredentialsMessage{} GUnixCredentialsMessage;/' final.h
sed -i 's/typedef struct _GUnixFDList                   GUnixFDList;/typedef struct _GUnixFDList{} GUnixFDList;/' final.h
sed -i 's/typedef struct _GDBusMessage                  GDBusMessage;/typedef struct _GDBusMessage{} GDBusMessage;/' final.h
sed -i 's/typedef struct _GDBusConnection               GDBusConnection;/typedef struct _GDBusConnection{} GDBusConnection;/' final.h
sed -i 's/typedef struct _GDBusMethodInvocation         GDBusMethodInvocation;/typedef struct _GDBusMethodInvocation{} GDBusMethodInvocation;/' final.h
sed -i 's/typedef struct _GDBusServer                   GDBusServer;/typedef struct _GDBusServer{} GDBusServer;/' final.h
sed -i 's/typedef struct _GDBusAuthObserver             GDBusAuthObserver;/typedef struct _GDBusAuthObserver{} GDBusAuthObserver;/' final.h
sed -i 's/typedef struct _GDBusInterface              GDBusInterface;/typedef struct _GDBusInterface{} GDBusInterface;/' final.h
sed -i 's/typedef struct _GDBusObject                 GDBusObject;/typedef struct _GDBusObject{} GDBusObject;/' final.h
sed -i 's/typedef struct _GDBusObjectManager          GDBusObjectManager;/typedef struct _GDBusObjectManager{} GDBusObjectManager;/' final.h
sed -i 's/typedef struct _GTestDBus GTestDBus;/typedef struct _GTestDBus{} GTestDBus;/' final.h
sed -i 's/typedef struct _GSubprocess                   GSubprocess;/typedef struct _GSubprocess{} GSubprocess;/' final.h
sed -i 's/typedef struct _GSubprocessLauncher           GSubprocessLauncher;/typedef struct _GSubprocessLauncher{} GSubprocessLauncher;/' final.h
sed -i 's/typedef struct _GAppLaunchContextPrivate GAppLaunchContextPrivate;/typedef struct _GAppLaunchContextPrivate{} GAppLaunchContextPrivate;/' final.h
sed -i 's/typedef struct _GAppInfoMonitor                             GAppInfoMonitor;/typedef struct _GAppInfoMonitor{} GAppInfoMonitor;/' final.h
sed -i 's/typedef struct _GApplicationPrivate                         GApplicationPrivate;/typedef struct _GApplicationPrivate{} GApplicationPrivate;/' final.h
sed -i 's/typedef struct _GApplicationCommandLinePrivate               GApplicationCommandLinePrivate;/typedef struct _GApplicationCommandLinePrivate{} GApplicationCommandLinePrivate;/' final.h
sed -i 's/typedef struct _GInputStreamPrivate  GInputStreamPrivate;/typedef struct _GInputStreamPrivate{} GInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GBufferedInputStreamPrivate  GBufferedInputStreamPrivate;/typedef struct _GBufferedInputStreamPrivate{} GBufferedInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GOutputStreamPrivate  GOutputStreamPrivate;/typedef struct _GOutputStreamPrivate{} GOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GBufferedOutputStreamPrivate  GBufferedOutputStreamPrivate;/typedef struct _GBufferedOutputStreamPrivate{} GBufferedOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GCancellablePrivate GCancellablePrivate;/typedef struct _GCancellablePrivate{} GCancellablePrivate;/' final.h
sed -i 's/typedef struct _GConverterInputStreamPrivate  GConverterInputStreamPrivate;/typedef struct _GConverterInputStreamPrivate{} GConverterInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GConverterOutputStreamPrivate  GConverterOutputStreamPrivate;/typedef struct _GConverterOutputStreamPrivate{} GConverterOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GCredentialsClass   GCredentialsClass;/typedef struct _GCredentialsClass{} GCredentialsClass;/' final.h
sed -i 's/typedef struct _GDataInputStreamPrivate  GDataInputStreamPrivate;/typedef struct _GDataInputStreamPrivate{} GDataInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GDataOutputStreamPrivate  GDataOutputStreamPrivate;/typedef struct _GDataOutputStreamPrivate{} GDataOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GDBusProxyPrivate GDBusProxyPrivate;/typedef struct _GDBusProxyPrivate{} GDBusProxyPrivate;/' final.h
sed -i 's/typedef struct _GEmblem        GEmblem;/typedef struct _GEmblem{} GEmblem;/' final.h
sed -i 's/typedef struct _GEmblemClass   GEmblemClass;/typedef struct _GEmblemClass{} GEmblemClass;/' final.h
sed -i 's/typedef struct _GEmblemedIconPrivate GEmblemedIconPrivate;/typedef struct _GEmblemedIconPrivate{} GEmblemedIconPrivate;/' final.h
sed -i 's/typedef struct _GFileEnumeratorPrivate  GFileEnumeratorPrivate;/typedef struct _GFileEnumeratorPrivate{} GFileEnumeratorPrivate;/' final.h
sed -i 's/typedef struct _GFileIconClass   GFileIconClass;/typedef struct _GFileIconClass{} GFileIconClass;/' final.h
sed -i 's/typedef struct _GFileInfoClass   GFileInfoClass;/typedef struct _GFileInfoClass{} GFileInfoClass;/' final.h
sed -i 's/typedef struct _GFileInputStreamPrivate  GFileInputStreamPrivate;/typedef struct _GFileInputStreamPrivate{} GFileInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GIOStreamPrivate                            GIOStreamPrivate;/typedef struct _GIOStreamPrivate{} GIOStreamPrivate;/' final.h
sed -i 's/typedef struct _GFileIOStreamPrivate  GFileIOStreamPrivate;/typedef struct _GFileIOStreamPrivate{} GFileIOStreamPrivate;/' final.h
sed -i 's/typedef struct _GFileMonitorPrivate	GFileMonitorPrivate;/typedef struct _GFileMonitorPrivate{} GFileMonitorPrivate;/' final.h
sed -i 's/typedef struct _GFileOutputStreamPrivate  GFileOutputStreamPrivate;/typedef struct _GFileOutputStreamPrivate{} GFileOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GInetAddressPrivate GInetAddressPrivate;/typedef struct _GInetAddressPrivate{} GInetAddressPrivate;/' final.h
sed -i 's/typedef struct _GInetAddressMaskPrivate GInetAddressMaskPrivate;/typedef struct _GInetAddressMaskPrivate{} GInetAddressMaskPrivate;/' final.h
sed -i 's/typedef struct _GInetSocketAddressPrivate GInetSocketAddressPrivate;/typedef struct _GInetSocketAddressPrivate{} GInetSocketAddressPrivate;/' final.h
sed -i 's/typedef struct _GIOModuleScope GIOModuleScope;/typedef struct _GIOModuleScope{} GIOModuleScope;/' final.h
sed -i 's/typedef struct _GIOModuleClass GIOModuleClass;/typedef struct _GIOModuleClass{} GIOModuleClass;/' final.h
sed -i 's/typedef struct _GMemoryInputStreamPrivate  GMemoryInputStreamPrivate;/typedef struct _GMemoryInputStreamPrivate{} GMemoryInputStreamPrivate;/' final.h
sed -i 's/typedef struct _GMemoryOutputStreamPrivate  GMemoryOutputStreamPrivate;/typedef struct _GMemoryOutputStreamPrivate{} GMemoryOutputStreamPrivate;/' final.h
sed -i 's/typedef struct _GMountOperationPrivate GMountOperationPrivate;/typedef struct _GMountOperationPrivate{} GMountOperationPrivate;/' final.h
sed -i 's/typedef struct _GNetworkAddressPrivate GNetworkAddressPrivate;/typedef struct _GNetworkAddressPrivate{} GNetworkAddressPrivate;/' final.h
sed -i 's/typedef struct _GNetworkServicePrivate GNetworkServicePrivate;/typedef struct _GNetworkServicePrivate{} GNetworkServicePrivate;/' final.h
sed -i 's/typedef struct _GPermissionPrivate    GPermissionPrivate;/typedef struct _GPermissionPrivate{} GPermissionPrivate;/' final.h
sed -i 's/typedef struct _GProxyAddressPrivate GProxyAddressPrivate;/typedef struct _GProxyAddressPrivate{} GProxyAddressPrivate;/' final.h
sed -i 's/typedef struct _GProxyAddressEnumeratorPrivate GProxyAddressEnumeratorPrivate;/typedef struct _GProxyAddressEnumeratorPrivate{} GProxyAddressEnumeratorPrivate;/' final.h
sed -i 's/typedef struct _GResolverPrivate GResolverPrivate;/typedef struct _GResolverPrivate{} GResolverPrivate;/' final.h
sed -i 's/typedef struct _GSettingsSchemaSource                       GSettingsSchemaSource;/typedef struct _GSettingsSchemaSource{} GSettingsSchemaSource;/' final.h
sed -i 's/typedef struct _GSettingsSchema                             GSettingsSchema;/typedef struct _GSettingsSchema{} GSettingsSchema;/' final.h
sed -i 's/typedef struct _GSettingsSchemaKey                          GSettingsSchemaKey;/typedef struct _GSettingsSchemaKey{} GSettingsSchemaKey;/' final.h
sed -i 's/typedef struct _GSettingsPrivate                            GSettingsPrivate;/typedef struct _GSettingsPrivate{} GSettingsPrivate;/' final.h
sed -i 's/typedef struct _GSimpleActionGroupPrivate                   GSimpleActionGroupPrivate;/typedef struct _GSimpleActionGroupPrivate{} GSimpleActionGroupPrivate;/' final.h
sed -i 's/typedef struct _GSimpleAsyncResultClass   GSimpleAsyncResultClass;/typedef struct _GSimpleAsyncResultClass{} GSimpleAsyncResultClass;/' final.h
sed -i 's/typedef struct _GSocketClientPrivate                        GSocketClientPrivate;/typedef struct _GSocketClientPrivate{} GSocketClientPrivate;/' final.h
sed -i 's/typedef struct _GSocketPrivate                              GSocketPrivate;/typedef struct _GSocketPrivate{} GSocketPrivate;/' final.h
sed -i 's/typedef struct _GSocketConnectionPrivate                    GSocketConnectionPrivate;/typedef struct _GSocketConnectionPrivate{} GSocketConnectionPrivate;/' final.h
sed -i 's/typedef struct _GSocketControlMessagePrivate                GSocketControlMessagePrivate;/typedef struct _GSocketControlMessagePrivate{} GSocketControlMessagePrivate;/' final.h
sed -i 's/typedef struct _GSocketListenerPrivate                      GSocketListenerPrivate;/typedef struct _GSocketListenerPrivate{} GSocketListenerPrivate;/' final.h
sed -i 's/typedef struct _GSocketServicePrivate                       GSocketServicePrivate;/typedef struct _GSocketServicePrivate{} GSocketServicePrivate;/' final.h
sed -i 's/typedef struct _GSimpleProxyResolverPrivate GSimpleProxyResolverPrivate;/typedef struct _GSimpleProxyResolverPrivate{} GSimpleProxyResolverPrivate;/' final.h
sed -i 's/typedef struct _GTaskClass   GTaskClass;/typedef struct _GTaskClass{} GTaskClass;/' final.h
sed -i 's/typedef struct _GTcpConnectionPrivate                       GTcpConnectionPrivate;/typedef struct _GTcpConnectionPrivate{} GTcpConnectionPrivate;/' final.h
sed -i 's/typedef struct _GTcpWrapperConnectionPrivate GTcpWrapperConnectionPrivate;/typedef struct _GTcpWrapperConnectionPrivate{} GTcpWrapperConnectionPrivate;/' final.h
sed -i 's/typedef struct _GThemedIconClass   GThemedIconClass;/typedef struct _GThemedIconClass{} GThemedIconClass;/' final.h
sed -i 's/typedef struct _GThreadedSocketServicePrivate               GThreadedSocketServicePrivate;/typedef struct _GThreadedSocketServicePrivate{} GThreadedSocketServicePrivate;/' final.h
sed -i 's/typedef struct _GTlsBackend          GTlsBackend;/typedef struct _GTlsBackend{} GTlsBackend;/' final.h
sed -i 's/typedef struct _GTlsCertificatePrivate GTlsCertificatePrivate;/typedef struct _GTlsCertificatePrivate{} GTlsCertificatePrivate;/' final.h
sed -i 's/typedef struct _GTlsConnectionPrivate GTlsConnectionPrivate;/typedef struct _GTlsConnectionPrivate{} GTlsConnectionPrivate;/' final.h
sed -i 's/typedef struct _GTlsDatabasePrivate GTlsDatabasePrivate;/typedef struct _GTlsDatabasePrivate{} GTlsDatabasePrivate;/' final.h
sed -i 's/typedef struct _GTlsInteractionPrivate GTlsInteractionPrivate;/typedef struct _GTlsInteractionPrivate{} GTlsInteractionPrivate;/' final.h
sed -i 's/typedef struct _GTlsPasswordPrivate GTlsPasswordPrivate;/typedef struct _GTlsPasswordPrivate{} GTlsPasswordPrivate;/' final.h
sed -i 's/typedef struct _GDBusInterfaceSkeletonPrivate GDBusInterfaceSkeletonPrivate;/typedef struct _GDBusInterfaceSkeletonPrivate{} GDBusInterfaceSkeletonPrivate;/' final.h
sed -i 's/typedef struct _GDBusObjectSkeletonPrivate GDBusObjectSkeletonPrivate;/typedef struct _GDBusObjectSkeletonPrivate{} GDBusObjectSkeletonPrivate;/' final.h
sed -i 's/typedef struct _GDBusObjectProxyPrivate GDBusObjectProxyPrivate;/typedef struct _GDBusObjectProxyPrivate{} GDBusObjectProxyPrivate;/' final.h
sed -i 's/typedef struct _GDBusObjectManagerClientPrivate GDBusObjectManagerClientPrivate;/typedef struct _GDBusObjectManagerClientPrivate{} GDBusObjectManagerClientPrivate;/' final.h
sed -i 's/typedef struct _GDBusObjectManagerServerPrivate GDBusObjectManagerServerPrivate;/typedef struct _GDBusObjectManagerServerPrivate{} GDBusObjectManagerServerPrivate;/' final.h
sed -i 's/typedef struct _GMenuModelPrivate                           GMenuModelPrivate;/typedef struct _GMenuModelPrivate{} GMenuModelPrivate;/' final.h
sed -i 's/typedef struct _GMenuAttributeIterPrivate                   GMenuAttributeIterPrivate;/typedef struct _GMenuAttributeIterPrivate{} GMenuAttributeIterPrivate;/' final.h
sed -i 's/typedef struct _GMenuLinkIterPrivate                        GMenuLinkIterPrivate;/typedef struct _GMenuLinkIterPrivate{} GMenuLinkIterPrivate;/' final.h
sed -i 's/typedef struct _GMenuItem GMenuItem;/typedef struct _GMenuItem{} GMenuItem;/' final.h
sed -i 's/typedef struct _GMenu     GMenu;/typedef struct _GMenu{} GMenu;/' final.h
sed -i 's/typedef struct _GDBusMenuModel GDBusMenuModel;/typedef struct _GDBusMenuModel{} GDBusMenuModel;/' final.h

ruby ../fix_.rb $final

# header for Nim module
i='#ifdef __INCREASE_TMP_INDENT__
#ifdef C2NIM
#  dynlib lib
#endif
#endif
'
perl -0777 -p -i -e "s/^/$i/" $final

i='#define G_TYPE_TEST_DBUS \
    (g_test_dbus_get_type ())
'
j='#define G_TYPE_TEST_DBUS (g_test_dbus_get_type ())
'
perl -0777 -p -i -e "s~\Q$i\E~$j~s" $final

ruby ../fix_gtk_type.rb final.h G_IO_
mv gtk_type_sedlist GIO_gtk_type_sedlist
ruby ../fix_gtk_type.rb final.h G_

sed -i '/#define G_DBUS_ERROR g_dbus_error_quark()/d' $final
sed -i '/#define G_IO_ERROR g_io_error_quark()/d' $final
sed -i '/#define G_RESOLVER_ERROR (g_resolver_error_quark ())/d' $final
sed -i '/#define G_RESOURCE_ERROR (g_resource_error_quark ())/d' $final
sed -i '/#define G_TLS_ERROR (g_tls_error_quark ())/d' $final

sed -i 's/\bgchar\b/char/g' $final
c2nim097 --skipcomments --skipinclude $final
sed -i -f GIO_gtk_type_sedlist final.nim
sed -i -f gtk_type_sedlist final.nim

#perl -0777 -p -i -e "s~([=:] proc \(.*?\)(?:: (?:ptr )?\w+)?)~\1 {.cdecl.}~sg" final.nim
perl -0777 -p -i -e "s~([=:] proc \(.*?\)(?:: (?:ptr ){0,2}\w+)?)~\1 {.cdecl.}~sg" final.nim

# we use our own defined pragma
sed -i "s/\bdynlib: lib\b/libgio/g" final.nim

ruby ../remdef.rb final.nim

sed -i '/ \? \?when not defined(__GIO_GIO_H_INSIDE__) and not defined(GIO_COMPILATION): /d'  final.nim

i='const 
  headerfilename* = '
perl -0777 -p -i -e "s~\Q$i\E~  ### ~sg" final.nim

sed -i '1d' final.nim
sed -i 's/^  //' final.nim

i=' {.deadCodeElim: on.}'
j='{.deadCodeElim: on.}

when defined(windows):
  const LIB_GIO = "libgio-2.0-0.dll"
elif defined(macosx):
  const LIB_GIO = "libgio-2.0(|-0).dylib"
else:
  const LIB_GIO = "libgio-2.0.so(|.0)"

{.pragma: libgio, cdecl, dynlib: LIB_GIO.}

IMPORTLIST

# from glibconfig.h.win32
const
  GLIB_SYSDEF_AF_UNIX = 1
  GLIB_SYSDEF_AF_INET = 2
  GLIB_SYSDEF_AF_INET6 = 23
  GLIB_SYSDEF_MSG_OOB = 1
  GLIB_SYSDEF_MSG_PEEK = 2
  GLIB_SYSDEF_MSG_DONTROUTE = 4
'
perl -0777 -p -i -e "s~\Q$i\E~$j~s" final.nim
ruby ../glib_fix_T.rb final.nim gio thereisnoremfix

sed -i 's/\*: var /*: ptr /g' final.nim
sed -i 's/): var /): ptr /g' final.nim

ruby ../glib_fix_proc.rb final.nim

perl -0777 -p -i -e "s/(\n\s*)(proc )(\w+)(\*\([^}]*va_list[^}]*\)[^}]*{[^}]*})/\ndiscard \"\"\"\$&\n\"\"\"/sg" final.nim

sed -i 's/\bproc ref\b/proc `ref`/g' final.nim
sed -i 's/\bproc export\b/proc `export`/g' final.nim
sed -i 's/\bproc bind\b/proc `bind`/g' final.nim
sed -i 's/\bproc block\b/proc `block`/g' final.nim

ruby ../glib_fix_enum_prefix.rb final.nim

i='type 
  GIOStreamSpliceFlags* {.size: sizeof(cint), pure.} = enum 
    NONE = 0, CLOSE_STREAM1 = (1 shl
        0), G_IO_STREAM_SPLICE_CLOSE_STREAM2 = (1 shl 1), 
    G_IO_STREAM_SPLICE_WAIT_FOR_BOTH = (1 shl 2)
'
j='type 
  GIOStreamSpliceFlags* {.size: sizeof(cint), pure.} = enum 
    NONE = 0, CLOSE_STREAM1 = (1 shl
        0), CLOSE_STREAM2 = (1 shl 1), 
    WAIT_FOR_BOTH = (1 shl 2)
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

i='type 
  GFileCopyFlags* {.size: sizeof(cint), pure.} = enum 
    NONE = 0, OVERWRITE = (1 shl 0), 
    BACKUP = (1 shl 1), NOFOLLOW_SYMLINKS = (1 shl
        2), G_FILE_COPY_ALL_METADATA = (1 shl 3), 
    G_FILE_COPY_NO_FALLBACK_FOR_MOVE = (1 shl 4), 
    G_FILE_COPY_TARGET_DEFAULT_PERMS = (1 shl 5)
'
j='type 
  GFileCopyFlags* {.size: sizeof(cint), pure.} = enum 
    NONE = 0, OVERWRITE = (1 shl 0), 
    BACKUP = (1 shl 1), NOFOLLOW_SYMLINKS = (1 shl
        2), ALL_METADATA = (1 shl 3), 
    NO_FALLBACK_FOR_MOVE = (1 shl 4), 
    TARGET_DEFAULT_PERMS = (1 shl 5)
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

i='type 
  GApplicationFlags* {.size: sizeof(cint), pure.} = enum 
    NONE, G_APPLICATION_IS_SERVICE = (1 shl 0), 
    G_APPLICATION_IS_LAUNCHER = (1 shl 1), 
    G_APPLICATION_HANDLES_OPEN = (1 shl 2), 
    G_APPLICATION_HANDLES_COMMAND_LINE = (1 shl 3), 
    G_APPLICATION_SEND_ENVIRONMENT = (1 shl 4), 
    G_APPLICATION_NON_UNIQUE = (1 shl 5)
'
j='type 
  GApplicationFlags* {.size: sizeof(cint), pure.} = enum 
    NONE, IS_SERVICE = (1 shl 0), 
    IS_LAUNCHER = (1 shl 1), 
    HANDLES_OPEN = (1 shl 2), 
    HANDLES_COMMAND_LINE = (1 shl 3), 
    SEND_ENVIRONMENT = (1 shl 4), 
    NON_UNIQUE = (1 shl 5)
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

i='    PROXY_AUTH_FAILED, PROXY_NEED_AUTH, 
    PROXY_NOT_ALLOWED, BROKEN_PIPE, 
    CONNECTION_CLOSED = BROKEN_PIPE, 
    NOT_CONNECTED
'
j='    PROXY_AUTH_FAILED, PROXY_NEED_AUTH, 
    PROXY_NOT_ALLOWED, BROKEN_PIPE, 
    NOT_CONNECTED
const
 CONNECTION_CLOSED = GIOErrorEnum.BROKEN_PIPE
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

# procs starting with underscore should be privat
perl -0777 -p -i -e "s~proc _\w+\*?\(.*?\}~~sg" final.nim

ruby ../underscorefix.rb final.nim

sed -i -f ../glib_sedlist final.nim
sed -i -f ../gobject_sedlist final.nim

ruby ../fix_template.rb final.nim

ruby ../fix_object_of.rb final.nim

i='### "gio/./giotypes.h"
'
j='type 
  GCancellablePrivateObj = object 
  
type 
  GCancellable* =  ptr GCancellableObj
  GCancellablePtr* = ptr GCancellableObj
  GCancellableObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GCancellablePrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

j='type 
  GSocketPrivateObj = object 
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
k='type 
  GSocket* =  ptr GSocketObj
  GSocketPtr* = ptr GSocketObj
  GSocketObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GSocketPrivateObj
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j$k%s" final.nim

j='type 
  GSocketAddress* =  ptr GSocketAddressObj
  GSocketAddressPtr* = ptr GSocketAddressObj
  GSocketAddressObj*{.final.} = object of gobject.GObjectObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

j='type 
  GSocketControlMessagePrivateObj = object 
  '
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
# caution, newline is necessary
k='
type 
  GSocketControlMessage* =  ptr GSocketControlMessageObj
  GSocketControlMessagePtr* = ptr GSocketControlMessageObj
  GSocketControlMessageObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GSocketControlMessagePrivateObj
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j$k%s" final.nim

j='type 
  GDBusObjectManagerClientPrivateObj = object 
  
type 
  GDBusObjectManagerClient* =  ptr GDBusObjectManagerClientObj
  GDBusObjectManagerClientPtr* = ptr GDBusObjectManagerClientObj
  GDBusObjectManagerClientObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GDBusObjectManagerClientPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GAppLaunchContextPrivateObj = object 
  
'
j='type 
  GAppLaunchContext* =  ptr GAppLaunchContextObj
  GAppLaunchContextPtr* = ptr GAppLaunchContextObj
  GAppLaunchContextObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GAppLaunchContextPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GApplicationPrivateObj = object 
  '
j='type 
  GApplicationCommandLinePrivateObj = object 
  
type 
  GApplicationCommandLine* =  ptr GApplicationCommandLineObj
  GApplicationCommandLinePtr* = ptr GApplicationCommandLineObj
  GApplicationCommandLineObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GApplicationCommandLinePrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$j$i%s" final.nim

i='type 
  GApplicationCommandLineClass* =  ptr GApplicationCommandLineClassObj
'
j='type 
  GInputStreamPrivateObj = object 
  
type 
  GInputStream* =  ptr GInputStreamObj
  GInputStreamPtr* = ptr GInputStreamObj
  GInputStreamObj*{.final.} = object of gobject.GObjectObj
    priv*: ptr GInputStreamPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$j$i%s" final.nim

i='from gobject import GObject, GType, GTypeInterface, GTypeInterfaceObj, GObjectClass, GCallback, GObjectObj, 
  GObjectClassObj, GValue, GClosure

from glib import gpointer, gboolean, goffset, guint64, gsize, gssize, gconstpointer, guint, gint, GList, GBytes,
  GDestroyNotify, gulong, GVariantType, GVariant, GError, guchar, gint16, gint32, gint64, guint32, GOptionGroup,
  GIOCondition, GOptionFlags, GOptionArg, guint16, GQuark, GSeekType, guint8, GSourceFunc, gdouble, GCompareDataFunc,
  GSpawnChildSetupFunc

from posix import TPid, TUid

type
  pid_t = TPid
  uid_t = TUid

'
perl -0777 -p -i -e "s%IMPORTLIST%$i%s" final.nim

sed -i 's/  GInputStreamObj\*{\.final\.} = object of gobject\.GObjectObj/  GInputStreamObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GInputStreamClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GInputStreamClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GFilterInputStreamObj\*{\.final\.} = object of GInputStreamObj/  GFilterInputStreamObj* = object of GInputStreamObj/' final.nim
sed -i 's/  GOutputStreamClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GOutputStreamClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GFilterInputStreamClassObj\*{\.final\.} = object of GInputStreamClassObj/  GFilterInputStreamClassObj* = object of GInputStreamClassObj/' final.nim
sed -i 's/  GOutputStreamObj\*{\.final\.} = object of gobject\.GObjectObj/  GOutputStreamObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GFilterOutputStreamObj\*{\.final\.} = object of GOutputStreamObj/  GFilterOutputStreamObj* = object of GOutputStreamObj/' final.nim
sed -i 's/  GFilterOutputStreamClassObj\*{\.final\.} = object of GOutputStreamClassObj/  GFilterOutputStreamClassObj* = object of GOutputStreamClassObj/' final.nim
sed -i 's/  GBufferedInputStreamObj\*{\.final\.} = object of GFilterInputStreamObj/  GBufferedInputStreamObj* = object of GFilterInputStreamObj/' final.nim
sed -i 's/  GBufferedInputStreamClassObj\*{\.final\.} = object of GFilterInputStreamClassObj/  GBufferedInputStreamClassObj* = object of GFilterInputStreamClassObj/' final.nim
sed -i 's/  GIOStreamObj\*{\.final\.} = object of gobject\.GObjectObj/  GIOStreamObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GIOStreamClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GIOStreamClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GSocketAddressObj\*{\.final\.} = object of gobject\.GObjectObj/  GSocketAddressObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GSocketAddressClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GSocketAddressClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GVolumeMonitorObj\*{\.final\.} = object of gobject\.GObjectObj/  GVolumeMonitorObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GVolumeMonitorClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GVolumeMonitorClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GInetSocketAddressClassObj\*{\.final\.} = object of GSocketAddressClassObj/  GInetSocketAddressClassObj* = object of GSocketAddressClassObj/' final.nim
sed -i 's/  GInetSocketAddressObj\*{\.final\.} = object of GSocketAddressObj/  GInetSocketAddressObj* = object of GSocketAddressObj/' final.nim
sed -i 's/  GSocketAddressEnumeratorObj\*{\.final\.} = object of gobject\.GObjectObj/  GSocketAddressEnumeratorObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GSocketAddressEnumeratorClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GSocketAddressEnumeratorClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GSocketListenerClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GSocketListenerClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GSocketListenerObj\*{\.final\.} = object of gobject\.GObjectObj/  GSocketListenerObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GSocketConnectionObj\*{\.final\.} = object of GIOStreamObj/  GSocketConnectionObj* = object of GIOStreamObj/' final.nim
sed -i 's/  GSocketConnectionClassObj\*{\.final\.} = object of GIOStreamClassObj/  GSocketConnectionClassObj* = object of GIOStreamClassObj/' final.nim
sed -i 's/  GTcpConnectionClassObj\*{\.final\.} = object of GSocketConnectionClassObj/  GTcpConnectionClassObj* = object of GSocketConnectionClassObj/' final.nim
sed -i 's/  GTcpConnectionObj\*{\.final\.} = object of GSocketConnectionObj/  GTcpConnectionObj* = object of GSocketConnectionObj/' final.nim
sed -i 's/  GSocketServiceClassObj\*{\.final\.} = object of GSocketListenerClassObj/  GSocketServiceClassObj* = object of GSocketListenerClassObj/' final.nim
sed -i 's/  GSocketServiceObj\*{\.final\.} = object of GSocketListenerObj/  GSocketServiceObj* = object of GSocketListenerObj/' final.nim
sed -i 's/  GApplicationObj\*{\.final\.} = object of gobject\.GObjectObj/  GApplicationObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GApplicationClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GApplicationClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GMountOperationObj\*{\.final\.} = object of gobject\.GObjectObj/  GMountOperationObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GMountOperationClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GMountOperationClassObj* = object of gobject.GObjectClassObj/' final.nim
sed -i 's/  GEmblemedIconObj\*{\.final\.} = object of gobject\.GObjectObj/  GEmblemedIconObj* = object of gobject.GObjectObj/' final.nim
sed -i 's/  GEmblemedIconClassObj\*{\.final\.} = object of gobject\.GObjectClassObj/  GEmblemedIconClassObj* = object of gobject.GObjectClassObj/' final.nim

ruby ../fix_reserved.rb final.nim

i='proc lookup*(annotations: var GDBusAnnotationInfo; 
                                    name: cstring): cstring {.
    importc: "g_dbus_annotation_info_lookup", libgio.}
'
j='proc register_object*(connection: GDBusConnection; 
    object_path: cstring; interface_info: GDBusInterfaceInfo; 
    vtable: GDBusInterfaceVTable; user_data: gpointer; 
    user_data_free_func: GDestroyNotify; error: var glib.GError): guint {.
    importc: "g_dbus_connection_register_object", libgio.}
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
k='type 
  GDBusSubtreeIntrospectFunc* = proc (connection: GDBusConnection; 
                                      sender: cstring; object_path: cstring; 
                                      node: cstring; user_data: gpointer): ptr GDBusInterfaceInfo {.cdecl.}
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$k$j$i%s" final.nim

i='type 
  GDBusSubtreeVTable* =  ptr GDBusSubtreeVTableObj
  GDBusSubtreeVTablePtr* = ptr GDBusSubtreeVTableObj
  GDBusSubtreeVTableObj* = object 
    enumerate*: GDBusSubtreeEnumerateFunc
    introspect*: GDBusSubtreeIntrospectFunc
    dispatch*: GDBusSubtreeDispatchFunc
    padding*: array[8, gpointer]

proc register_subtree*(connection: GDBusConnection; 
    object_path: cstring; vtable: GDBusSubtreeVTable; 
    flags: GDBusSubtreeFlags; user_data: gpointer; 
    user_data_free_func: GDestroyNotify; error: var glib.GError): guint {.
    importc: "g_dbus_connection_register_subtree", libgio.}
'
perl -0777 -p -i -e "s%\Q$i\E%%s" final.nim
j='type 
  GDBusSubtreeIntrospectFunc* = proc (connection: GDBusConnection; 
                                      sender: cstring; object_path: cstring; 
                                      node: cstring; user_data: gpointer): ptr GDBusInterfaceInfo {.cdecl.}
'
perl -0777 -p -i -e "s%\Q$j\E%$j$i%s" final.nim

i='type 
  GMountOperationPrivateObj = object 
  
type 
  GMountOperation* =  ptr GMountOperationObj
  GMountOperationPtr* = ptr GMountOperationObj
  GMountOperationObj* = object of gobject.GObjectObj
    priv29*: ptr GMountOperationPrivateObj
'
j='### "gio/./gdrive.h"
'
perl -0777 -p -i -e "s%\Q$i\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$j\E%$j$i%s" final.nim

i='### "gio/./gfile.h"
'
j='type 
  GFileInputStreamPrivateObj = object 
  
type 
  GFileInputStream* =  ptr GFileInputStreamObj
  GFileInputStreamPtr* = ptr GFileInputStreamObj
  GFileInputStreamObj*{.final.} = object of GInputStreamObj
    priv19*: ptr GFileInputStreamPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

j='type 
  GFileMonitorPrivateObj = object 
  
type 
  GFileMonitor* =  ptr GFileMonitorObj
  GFileMonitorPtr* = ptr GFileMonitorObj
  GFileMonitorObj*{.final.} = object of gobject.GObjectObj
    priv22*: ptr GFileMonitorPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

j='type 
  GFileOutputStreamPrivateObj = object 
  
type 
  GFileOutputStream* =  ptr GFileOutputStreamObj
  GFileOutputStreamPtr* = ptr GFileOutputStreamObj
  GFileOutputStreamObj*{.final.} = object of GOutputStreamObj
    priv23*: ptr GFileOutputStreamPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

j='type 
  GFileIOStreamPrivateObj = object 
  
type 
  GFileIOStream* =  ptr GFileIOStreamObj
  GFileIOStreamPtr* = ptr GFileIOStreamObj
  GFileIOStreamObj*{.final.} = object of GIOStreamObj
    priv21*: ptr GFileIOStreamPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gdbusaddress.h"
'
j='type 
  GIOStreamPrivateObj = object 
  
type 
  GIOStream* =  ptr GIOStreamObj
  GIOStreamPtr* = ptr GIOStreamObj
  GIOStreamObj* = object of gobject.GObjectObj
    priv20*: ptr GIOStreamPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gproxy.h"
'
j='type 
  GProxyAddressPrivateObj = object 
  
type 
  GProxyAddress* =  ptr GProxyAddressObj
  GProxyAddressPtr* = ptr GProxyAddressObj
  GProxyAddressObj*{.final.} = object of GInetSocketAddressObj
    priv34*: ptr GProxyAddressPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GSettingsPrivateObj = object 
  
'
j='type 
  GSettings* =  ptr GSettingsObj
  GSettingsPtr* = ptr GSettingsObj
  GSettingsObj*{.final.} = object of gobject.GObjectObj
    priv37*: ptr GSettingsPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GSocketClientPrivateObj = object 
  
'
j='type 
  GSocketClient* =  ptr GSocketClientObj
  GSocketClientPtr* = ptr GSocketClientObj
  GSocketClientObj*{.final.} = object of gobject.GObjectObj
    priv39*: ptr GSocketClientPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GSocketClientPrivateObj = object 
  
'
j='type 
  GSocketConnectionPrivateObj = object 
  
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
k='type 
  GSocketConnection* =  ptr GSocketConnectionObj
  GSocketConnectionPtr* = ptr GSocketConnectionObj
  GSocketConnectionObj* = object of GIOStreamObj
    priv40*: ptr GSocketConnectionPrivateObj
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j$k%s" final.nim

i='type 
  GSocketListenerPrivateObj = object 
  
'
j='type 
  GSocketListener* =  ptr GSocketListenerObj
  GSocketListenerPtr* = ptr GSocketListenerObj
  GSocketListenerObj* = object of gobject.GObjectObj
    priv41*: ptr GSocketListenerPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GSocketServicePrivateObj = object 
  
'
j='type 
  GSocketService* =  ptr GSocketServiceObj
  GSocketServicePtr* = ptr GSocketServiceObj
  GSocketServiceObj* = object of GSocketListenerObj
    priv42*: ptr GSocketServicePrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='type 
  GThreadedSocketServicePrivateObj = object 
  
'
j='type 
  GThreadedSocketService* =  ptr GThreadedSocketServiceObj
  GThreadedSocketServicePtr* = ptr GThreadedSocketServiceObj
  GThreadedSocketServiceObj*{.final.} = object of GSocketServiceObj
    priv46*: ptr GThreadedSocketServicePrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gtlsbackend.h"
'
j='type 
  GTlsDatabasePrivateObj = object 
  
type 
  GTlsDatabase* =  ptr GTlsDatabaseObj
  GTlsDatabasePtr* = ptr GTlsDatabaseObj
  GTlsDatabaseObj*{.final.} = object of gobject.GObjectObj
    priv49*: ptr GTlsDatabasePrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gtlsconnection.h"
'
j='type 
  GTlsInteractionPrivateObj = object 
  
type 
  GTlsInteraction* =  ptr GTlsInteractionObj
  GTlsInteractionPtr* = ptr GTlsInteractionObj
  GTlsInteractionObj*{.final.} = object of gobject.GObjectObj
    priv50*: ptr GTlsInteractionPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gtlsinteraction.h"
'
j='type 
  GTlsPasswordPrivateObj = object 
  
type 
  GTlsPassword* =  ptr GTlsPasswordObj
  GTlsPasswordPtr* = ptr GTlsPasswordObj
  GTlsPasswordObj*{.final.} = object of gobject.GObjectObj
    priv51*: ptr GTlsPasswordPrivateObj
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i$j%s" final.nim

i='### "gio/./gmenumodel.h"
'
j='  GMenuAttributeIterPrivateObj = object 
  
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
k='type 
  GMenuAttributeIter* =  ptr GMenuAttributeIterObj
  GMenuAttributeIterPtr* = ptr GMenuAttributeIterObj
  GMenuAttributeIterObj*{.final.} = object of gobject.GObjectObj
    priv57*: ptr GMenuAttributeIterPrivateObj
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i\ntype\n$j$k%s" final.nim

j='  GMenuLinkIterPrivateObj = object 
  
'
perl -0777 -p -i -e "s%\Q$j\E%%s" final.nim
k='type 
  GMenuLinkIter* =  ptr GMenuLinkIterObj
  GMenuLinkIterPtr* = ptr GMenuLinkIterObj
  GMenuLinkIterObj*{.final.} = object of gobject.GObjectObj
    priv58*: ptr GMenuLinkIterPrivateObj
'
perl -0777 -p -i -e "s%\Q$k\E%%s" final.nim
perl -0777 -p -i -e "s%\Q$i\E%$i\ntype\n$j$k%s" final.nim

i='type 
  GApplicationClass* =  ptr GApplicationClassObj
  GApplicationClassPtr* = ptr GApplicationClassObj
  GApplicationClassObj* = object of gobject.GObjectClassObj
    startup*: proc (application: GApplication) {.cdecl.}
    activate*: proc (application: GApplication) {.cdecl.}
    open*: proc (application: GApplication; files: var GFile; 
                 n_files: gint; hint: cstring) {.cdecl.}
    command_line*: proc (application: GApplication; 
                         command_line: GApplicationCommandLine): cint {.cdecl.}
    local_command_line*: proc (application: GApplication; 
                               arguments: ptr cstringArray; 
                               exit_status: ptr cint): gboolean {.cdecl.}
    before_emit*: proc (application: GApplication; 
                        platform_data: glib.GVariant) {.cdecl.}
    after_emit*: proc (application: GApplication; 
                       platform_data: glib.GVariant) {.cdecl.}
    add_platform_data*: proc (application: GApplication; 
                              builder: glib.GVariantBuilder) {.cdecl.}
    quit_mainloop*: proc (application: GApplication) {.cdecl.}
    run_mainloop*: proc (application: GApplication) {.cdecl.}
    shutdown*: proc (application: GApplication) {.cdecl.}
    dbus_register*: proc (application: GApplication; 
                          connection: GDBusConnection; 
                          object_path: cstring; error: var glib.GError): gboolean {.cdecl.}
    dbus_unregister*: proc (application: GApplication; 
                            connection: GDBusConnection; 
                            object_path: cstring) {.cdecl.}
    handle_local_options*: proc (application: GApplication; 
                                 options: glib.GVariantDict): gint {.cdecl.}
    padding*: array[8, gpointer]
'
j='type 
  GApplicationClass* =  ptr GApplicationClassObj
  GApplicationClassPtr* = ptr GApplicationClassObj
  GApplicationClassObj* = object of gobject.GObjectClassObj
    startup*: proc (application: GApplication) {.cdecl.}
    activate*: proc (application: GApplication) {.cdecl.}
    open*: proc (application: GApplication; files: var GFile; 
                 n_files: gint; hint: cstring) {.cdecl.}
    command_line*: proc (application: GApplication; 
                         command_line: GApplicationCommandLine): cint {.cdecl.}
    local_command_line*: proc (application: GApplication; 
                               arguments: ptr cstringArray; 
                               exit_status: ptr cint): gboolean {.cdecl.}
    before_emit*: proc (application: GApplication; 
                        platform_data: glib.GVariant) {.cdecl.}
    after_emit*: proc (application: GApplication; 
                       platform_data: glib.GVariant) {.cdecl.}
    add_platform_data*: proc (application: GApplication; 
                              builder: glib.GVariantBuilder) {.cdecl.}
    quit_mainloop*: proc (application: GApplication) {.cdecl.}
    run_mainloop*: proc (application: GApplication) {.cdecl.}
    shutdown*: proc (application: GApplication) {.cdecl.}
    dbus_register*: proc (application: GApplication; 
                          connection: GDBusConnection; 
                          object_path: cstring; error: var glib.GError): gboolean {.cdecl.}
    dbus_unregister*: proc (application: GApplication; 
                            connection: GDBusConnection; 
                            object_path: cstring) {.cdecl.}
    handle_local_options*: proc (application: GApplication; 
                                 options: glib.GVariantDict): gint {.cdecl.}
    padding0*: array[8, gpointer]
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

# do not export priv and reserved
sed -i "s/\( priv[0-9]\?[0-9]\?[0-9]\?\)\*: /\1: /g" final.nim
sed -i "s/\(reserved[0-9]\?[0-9]\?[0-9]\?\)\*: /\1: /g" final.nim

# generate procs without get_ and set_ prefix
perl -0777 -p -i -e "s/(\n\s*)(proc set_)(\w+)(\*\([^}]*\) {[^}]*})/\$&\1proc \`\3=\`\4/sg" final.nim
perl -0777 -p -i -e "s/(\n\s*)(proc get_)(\w+)(\*\([^}]*\): \w[^}]*})/\$&\1proc \3\4/sg" final.nim

sed -i 's/\bproc type\b/proc `type`/g' final.nim
sed -i 's/\bproc object\b/proc `object`/g' final.nim
sed -i 's/\bproc enum\b/proc `enum`/g' final.nim
sed -i 's/\bproc interface\b/proc `interface`/g' final.nim
sed -i 's/\bproc converter\b/proc `converter`/g' final.nim

sed -i 's/\(dummy[0-9]\{0,2\}\)\*/\1/g' final.nim
sed -i 's/\(reserved[0-9]\{0,2\}\)\*/\1/g' final.nim

sed -i 's/[(][(]\(`\{0,1\}\w\+`\{0,1\}\)[)]/(\1/g' final.nim
sed -i 's/, [(]\(`\{0,1\}\w\+`\{0,1\}\)[)]/, \1/g' final.nim

sed -i 's/\([,=(<>] \{0,1\}\)[(]\(`\{0,1\}\w\+`\{0,1\}\)[)]/\1\2/g' final.nim
sed -i '/^ \? \?#type $/d' final.nim
sed -i 's/\bgobject\.\(GObjectObj\)\b/\1/g' final.nim
sed -i 's/\bgobject\.\(GObject\)\b/\1/g' final.nim
sed -i 's/\bgobject\.\(GObjectClassObj\)\b/\1/g' final.nim

sed -i 's/ ptr gchar\b/ cstring/g' final.nim
sed -i 's/ ptr var / var ptr /g' final.nim

# the gobject lower case templates
sed -i 's/\bG_TYPE_CHECK_CLASS_TYPE\b/\L&/g' final.nim
sed -i 's/\bG_TYPE_CHECK_CLASS_CAST\b/\L&/g' final.nim
sed -i 's/\bG_TYPE_INSTANCE_GET_CLASS\b/\L&/g' final.nim
sed -i 's/\bG_TYPE_CHECK_INSTANCE_CAST\b/\L&/g' final.nim
sed -i 's/\bG_TYPE_CHECK_INSTANCE_TYPE\b/\L&/g' final.nim
sed -i 's/\bG_TYPE_INSTANCE_GET_INTERFACE\b/\L&/g' final.nim

sed -i 's/\bptr cstring\b/cstringArray/g' final.nim

# yes, call multiple times!
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gu?int\d?\d?)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gu?int\d?\d?)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gu?int\d?\d?)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gu?int\d?\d?)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gdouble)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gdouble)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gfloat)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gfloat)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( cint)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gboolean)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gsize)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( guchar)/\1\2\3\4var\6/sg' final.nim
perl -0777 -p -i -e 's/(proc )(`?\w+=?`?\*)?([(])([^)]* )(ptr)( gpointer)/\1\2\3\4var\6/sg' final.nim

sed -i 's/: ptr var /: var ptr /g' final.nim
sed -i 's/\(0x\)0*\([0123456789ABCDEF]\)/\1\2/g' final.nim

# some procs with get_ prefix do not return something but need var objects instead of pointers:
# vim search term for candidates: proc get_.*\n\?.*\n\?.*) {
i='proc get_modification_time*(info: GFileInfo;
    result: glib.GTimeVal) {.importc: "g_file_info_get_modification_time",
                            libgio.}
'
j='proc get_modification_time*(info: GFileInfo;
    result: var glib.GTimeValObj) {.importc: "g_file_info_get_modification_time",
                            libgio.}
'
perl -0777 -p -i -e "s%\Q$i\E%$j%s" final.nim

sed -i 's/ $//g' final.nim
sed -i '/### "gio/d' final.nim

ruby ../gen_proc_dep.rb final.nim

sed -i 's/\bglib\.\(GError\)\b/\1/g' final.nim
sed -i 's/\bglib\.\(GVariantType\)\b/\1/g' final.nim
sed -i 's/\bglib\.\(GVariant\)\b/\1/g' final.nim
sed -i 's/\bglib\.\(GList\)\b/\1/g' final.nim
sed -i 's/\bgobject\.\(GTypeInterfaceObj\)\b/\1/g' final.nim
sed -i 's/\bgobject\.\(GValue\)\b/\1/g' final.nim
sed -i 's/\bgobject\.\(GClosure\)\b/\1/g' final.nim

sed -i 's/when defined(G_OS_UNIX):/when defined(unix):/g' final.nim
sed -i 's/when defined(G_OS_WIN32):/when defined(windows):/g' final.nim

sed -i '/{\.deprecated: \[g_output_stream_vprintf: vprintf\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_message_new_method_error_valist: new_method_error_valist\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_method_invocation_return_error_valist: return_error_valist\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_simple_async_result_set_error_va: set_error_va\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_credentials_get_unix_pid: get_unix_pid\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_credentials_get_unix_user: get_unix_user\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_credentials_set_unix_user: set_unix_user\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_connection_call_with_unix_fd_list: call_with_unix_fd_list\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_connection_call_with_unix_fd_list_finish: call_with_unix_fd_list_finish\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_connection_call_with_unix_fd_list_sync: call_with_unix_fd_list_sync\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_message_get_unix_fd_list: get_unix_fd_list\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_message_set_unix_fd_list: set_unix_fd_list\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_message_get_num_unix_fds: get_num_unix_fds\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_message_set_num_unix_fds: set_num_unix_fds\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_method_invocation_return_value_with_unix_fd_list: return_value_with_unix_fd_list\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_proxy_call_with_unix_fd_list: call_with_unix_fd_list\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_proxy_call_with_unix_fd_list_finish: call_with_unix_fd_list_finish\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_dbus_proxy_call_with_unix_fd_list_sync: call_with_unix_fd_list_sync\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_send_signal: send_signal\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_set_stdin_file_path: set_stdin_file_path\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_take_stdin_fd: take_stdin_fd\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_set_stdout_file_path: set_stdout_file_path\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_take_stdout_fd: take_stdout_fd\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_set_stderr_file_path: set_stderr_file_path\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_take_stderr_fd: take_stderr_fd\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_take_fd: take_fd\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_subprocess_launcher_set_child_setup: set_child_setup\]\.}/d' proc_dep_list
sed -i '/{\.deprecated: \[g_file_monitor: monitor\]\.}/d' proc_dep_list

cat proc_dep_list >> final.nim

cat -s final.nim > gio.nim

rm final.h list.txt final.nim proc_dep_list GIO_gtk_type_sedlist gtk_type_sedlist
rm -r gio

exit

